---

- name: Prepare inventory
  hosts: localhost
  gather_facts: no
  vars:
    master_pattern: "^master[0-9]+$"
    worker_pattern: "^worker[0-9]+$"
  tasks:
    - name: Create group for masters
      add_host:
        name: "{{ item }}"
        groups:
          - k8s
          - controller
        ansible_user: root
        ansible_ssh_private_key_file: "~/id_rsa_hetzner"
      with_items: "{{ groups['all'] | select('match', master_pattern) | list }}"
    - name: Create group for first master
      add_host:
        name: "{{ groups['controller'] | first() }}"
        groups:
          - first_controller
    - name: Create group for additional masters
      add_host:
        name: "{{ item }}"
        groups:
          - additional_controllers
      with_items: "{{ groups['controller'] | difference(groups['first_controller']) }}"
    - name: Create group for masters
      add_host:
        name: "{{ item }}"
        groups:
          - k8s
          - worker
        ansible_user: root
        ansible_ssh_private_key_file: "~/id_rsa_hetzner"
      with_items: "{{ groups['all'] | select('match', worker_pattern) | list }}"

- name: Prepare all nodes
  hosts: k8s
  roles:
    - role: docker
      docker:
        version: "18.06.*"
    - role: k8s-node-prepare
  tags:
    - k8s-node-prepare

- name: Prepare DNS
  hosts: first_controller
  vars:
    dns_zone: dille.io
    dns_record: k8s
  tasks:
    - name: Clear DNS records for load balancer
      cloudflare_dns:
        zone: "{{ dns_zone }}"
        record: "{{ dns_record }}"
        type: A
        state: absent
        account_email: "{{ cloudflare.email }}"
        account_api_token: "{{ cloudflare.token }}"
    - name: Create DNS record for first node
      cloudflare_dns:
        zone: "{{ dns_zone }}"
        record: "{{ dns_record }}"
        type: A
        value: "{{ ansible_default_ipv4.address }}"
        account_email: "{{ cloudflare.email }}"
        account_api_token: "{{ cloudflare.token }}"

- name: Initialize cluster
  hosts: first_controller
  roles:
    - role: k8s-cluster-init
    - role: k8s-cni-weave
  tags:
    - k8s-cluster-init

- name: Deploy additional masters
  hosts: additional_controllers
  serial: 1
  vars:
    first_controller: "{{ groups['cluster_init'][0] }}"
    dns_zone: dille.io
    dns_record: k8s
  roles:
    - role: k8s-controller-join
  tasks:
    - name: Add DNS record for load balancer
      cloudflare_dns:
        zone: "{{ dns_zone }}"
        record: "{{ dns_record }}"
        type: A
        value: "{{ ansible_default_ipv4.address }}"
        account_email: "{{ cloudflare.email }}"
        account_api_token: "{{ cloudflare.token }}"
  tags:
    - k8s-controller-join

- name: Configure control planes
  hosts: controller
  roles:
    - role: k8s-controller-finish
    - role: k8s-controller-all-nodeports
  tags:
    - k8s-controller-all-nodeports

- name: Deploy workers
  hosts: worker
  roles:
    - role: k8s-worker-join
  tags:
    - k8s-worker-join
